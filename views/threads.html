<% layout('layout') -%>

<h3>Threads (<%= status %>)</h3>

<!-- status filter + search -->
<form method="get" action="/admin/threads" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
  <select name="status" onchange="this.form.submit()">
    <option value="pending"  <%= status==='pending'  ? 'selected' : '' %>>pending</option>
    <option value="approved" <%= status==='approved' ? 'selected' : '' %>>approved</option>
    <option value="rejected" <%= status==='rejected' ? 'selected' : '' %>>rejected</option>
  </select>

  <!-- search by title or exact _id -->
  <input
    type="text"
    name="q"
    placeholder="Search by title or exact ID"
    value="<%= (typeof q !== 'undefined' && q) ? q : '' %>"
    style="min-width:260px;"
  />
  <button class="community-btn" type="submit">Search</button>

  <% if (q) { %>
    <a class="community-btn" href="/admin/threads?status=<%= encodeURIComponent(status) %>">Clear</a>
  <% } %>
</form>

<div style="margin-top:10px;">
  <% items.forEach(function(t){ %>
    <% const isClosed = !!(t.closedAt || t.closed); %>
    <div class="community-card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <strong>
            <a href="/admin/threads/<%= t._id %>"><%= t.title || '(untitled)' %></a>
          </strong>
          <%= t.pinned ? '<span class="badge">Pinned</span>' : '' %>
          <%= isClosed ? '<span class="badge">Closed</span>' : '' %>
          <span class="community-meta" style="margin-left:6px;"><%= t._id %></span>
        </div>
        <div class="community-meta"><%= new Date(t.createdAt).toLocaleString() %></div>
      </div>

      <div><%= t.body %></div>
      <div style="margin:6px 0;">
        Votes: <%= t.votes || 0 %> â€¢ Comments: <%= t.commentsCount || 0 %>
      </div>

      <form method="post" action="/admin/threads/<%= t._id %>/approve" style="display:inline;">
        <button class="community-btn">Approve</button>
      </form>
      <form method="post" action="/admin/threads/<%= t._id %>/reject" style="display:inline;">
        <button class="community-btn">Reject</button>
      </form>

      <% if (t.pinned) { %>
        <form method="post" action="/admin/threads/<%= t._id %>/unpin" style="display:inline;">
          <button class="community-btn">Unpin</button>
        </form>
      <% } else { %>
        <form method="post" action="/admin/threads/<%= t._id %>/pin" style="display:inline;">
          <button class="community-btn">Pin</button>
        </form>
      <% } %>

      <% if (isClosed) { %>
        <form method="post" action="/admin/threads/<%= t._id %>/reopen" style="display:inline;">
          <button class="community-btn">Reopen</button>
        </form>
      <% } else { %>
        <form method="post" action="/admin/threads/<%= t._id %>/close" style="display:inline;">
          <button class="community-btn">Close</button>
        </form>
      <% } %>
    </div>
  <% }) %>
</div>
